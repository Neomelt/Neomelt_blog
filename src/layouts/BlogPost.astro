---
import type { CollectionEntry } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";
import Comments from "../components/Comments.astro";
import TableOfContents from "../components/TableOfContents.astro";
import PostNavigation from "../components/PostNavigation.astro";
import BaseLayout from "./BaseLayout.astro";

export interface Props {
    post: CollectionEntry<"blog"> | CollectionEntry<"zueg">;
    headings: { depth: number; slug: string; text: string }[];
    prevPost?: CollectionEntry<"blog"> | CollectionEntry<"zueg"> | null;
    nextPost?: CollectionEntry<"blog"> | CollectionEntry<"zueg"> | null;
    collection?: "blog" | "zueg";
}

const { post, headings, prevPost, nextPost, collection = "blog" } = Astro.props;
const { title, description, pubDate, updatedDate, tags } = post.data;

const wordCount = (post.body || "").length;
const readingTime = Math.max(1, Math.ceil(wordCount / 400));
const hasToc = headings.filter(h => h.depth <= 3).length > 0;
---

<BaseLayout title={title} description={description}>
    <div class="post-page">
        <!-- TOC sidebar (desktop) -->
        {hasToc && (
            <aside class="toc-sidebar">
                <TableOfContents headings={headings} />
            </aside>
        )}

        <main class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb" aria-label="面包屑">
                <a href="/">首页</a>
                <span class="breadcrumb-sep">/</span>
                <a href="/posts">文章</a>
                <span class="breadcrumb-sep">/</span>
                <span>{title}</span>
            </nav>

            <article>
                <!-- Post header -->
                <header class="post-header">
                    <h1 class="post-title">{title}</h1>
                    <div class="post-meta-row">
                        <FormattedDate date={pubDate} />
                        {updatedDate && (
                            <span class="text-muted text-sm">（更新于 <FormattedDate date={updatedDate} />）</span>
                        )}
                        <span class="text-muted">·</span>
                        <span class="text-muted text-sm">{wordCount} 字 · {readingTime} 分钟</span>
                        {collection === "zueg" && <span class="tag">随笔</span>}
                    </div>
                    {tags && tags.length > 0 && (
                        <div class="post-tags-row">
                            {tags.map((tag: string) => (
                                <a href={`/tags#${tag}`} class="tag">#{tag}</a>
                            ))}
                        </div>
                    )}
                </header>

                <!-- Mobile TOC (collapsible) -->
                {hasToc && (
                    <details class="mobile-toc">
                        <summary>目录</summary>
                        <TableOfContents headings={headings} />
                    </details>
                )}

                <!-- Post content -->
                <div class="prose">
                    <slot />
                </div>

                <!-- Post navigation -->
                <PostNavigation prevPost={prevPost} nextPost={nextPost} collection={collection} />

                <!-- Comments -->
                <Comments />
            </article>
        </main>
    </div>
</BaseLayout>

<style>
    .post-page {
        display: flex;
        justify-content: center;
        gap: 2rem;
        padding-top: 0;
    }

    /* Main content column */
    main.container {
        flex: 1;
        min-width: 0;
        max-width: var(--content-width);
    }

    /* Post header */
    .post-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .post-title {
        font-size: 1.875rem;
        font-weight: 700;
        line-height: 1.3;
        margin-bottom: 0.75rem;
        color: var(--text);
    }

    .post-meta-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
    }

    .post-tags-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    /* Mobile TOC */
    .mobile-toc {
        display: none;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 1.5rem;
        background: var(--bg-card);
    }

    .mobile-toc summary {
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        color: var(--text);
        list-style: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .mobile-toc summary::before {
        content: "▶";
        font-size: 0.65rem;
        transition: transform 150ms ease;
    }

    .mobile-toc[open] summary::before {
        transform: rotate(90deg);
    }

    /* Desktop TOC sidebar */
    .toc-sidebar {
        display: none;
        width: 220px;
        flex-shrink: 0;
        position: sticky;
        top: calc(var(--header-height) + 2rem);
        max-height: calc(100vh - var(--header-height) - 4rem);
        overflow-y: auto;
        align-self: flex-start;
    }

    @media (min-width: 1100px) {
        .toc-sidebar {
            display: block;
        }
    }

    @media (max-width: 1099px) {
        .mobile-toc {
            display: block;
        }
    }
</style>
