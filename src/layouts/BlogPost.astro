---
import type { CollectionEntry } from "astro:content";
import FormattedDate from "../components/FormattedDate.astro";
import Comments from "../components/Comments.astro";
import TableOfContents from "../components/TableOfContents.astro";
import PostNavigation from "../components/PostNavigation.astro";
import BaseLayout from "./BaseLayout.astro";
import { getWalinePathForPost } from "../utils/waline";
import { getDefaultUiText } from "../i18n/ui";
import { resolvePostDates } from "../utils/post-dates";

export interface Props {
    post: CollectionEntry<"blog"> | CollectionEntry<"zueg">;
    headings: { depth: number; slug: string; text: string }[];
    prevPost?: CollectionEntry<"blog"> | CollectionEntry<"zueg"> | null;
    nextPost?: CollectionEntry<"blog"> | CollectionEntry<"zueg"> | null;
    collection?: "blog" | "zueg";
}

const { post, headings, prevPost, nextPost, collection = "blog" } = Astro.props;
const { title, description, tags } = post.data;
const { pubDate: resolvedPubDate, updatedDate: resolvedUpdatedDate } = await resolvePostDates(post);
const walinePath = getWalinePathForPost(post.id, collection);
const shouldShowUpdated = resolvedUpdatedDate.valueOf() > resolvedPubDate.valueOf();

const wordCount = (post.body || "").length;
const readingTime = Math.max(1, Math.ceil(wordCount / 400));
const hasToc = headings.filter(h => h.depth <= 3).length > 0;
---

<BaseLayout title={title} description={description}>
    <div class="post-page">
        <!-- TOC sidebar (desktop) -->
        {hasToc && (
            <aside class="toc-sidebar">
                <TableOfContents headings={headings} />
            </aside>
        )}

        <main class="container">
            <!-- Breadcrumb -->
            <nav class="breadcrumb" data-i18n-aria-label="post.breadcrumbAria" aria-label={getDefaultUiText("post.breadcrumbAria")}>
                <a href="/" data-i18n="common.home">{getDefaultUiText("common.home")}</a>
                <span class="breadcrumb-sep">/</span>
                <a href="/posts" data-i18n="common.posts">{getDefaultUiText("common.posts")}</a>
                <span class="breadcrumb-sep">/</span>
                <span>{title}</span>
            </nav>

            <article>
                <!-- Post header -->
                <header class="post-header">
                    <h1 class="post-title">{title}</h1>
                    <div class="post-meta-row">
                        <FormattedDate date={resolvedPubDate} showTime={true} />
                        {shouldShowUpdated && (
                            <span class="text-muted text-sm">（<span data-i18n="common.updatedAt">{getDefaultUiText("common.updatedAt")}</span> <FormattedDate date={resolvedUpdatedDate} showTime={true} />）</span>
                        )}
                        <span class="text-muted">·</span>
                        <span class="text-muted text-sm">
                            {wordCount} <span data-i18n="common.words">{getDefaultUiText("common.words")}</span> · {readingTime} <span data-i18n="common.minutes">{getDefaultUiText("common.minutes")}</span>
                        </span>
                        {collection === "zueg" && <span class="tag" data-i18n="common.essay">{getDefaultUiText("common.essay")}</span>}
                    </div>
                    <div class="post-stats" data-i18n-aria-label="post.statsAria" aria-label={getDefaultUiText("post.statsAria")}>
                        <p class="post-stats-line">
                            <span class="waline-pageview-count" data-path={walinePath}>0</span> <span data-i18n="common.views">{getDefaultUiText("common.views")}</span> /
                            <span class="waline-comment-count" data-path={walinePath}>0</span> <span data-i18n="common.comments">{getDefaultUiText("common.comments")}</span>
                        </p>
                    </div>
                    {tags && tags.length > 0 && (
                        <div class="post-tags-row">
                            {tags.map((tag: string) => (
                                <a href={`/tags#${tag}`} class="tag">#{tag}</a>
                            ))}
                        </div>
                    )}
                </header>

                <!-- Mobile TOC (collapsible) -->
                {hasToc && (
                    <details class="mobile-toc">
                        <summary data-i18n="common.toc">{getDefaultUiText("common.toc")}</summary>
                        <TableOfContents headings={headings} />
                    </details>
                )}

                <!-- Post content -->
                <div class="prose">
                    <slot />
                </div>

                <!-- Post navigation -->
                <PostNavigation prevPost={prevPost} nextPost={nextPost} collection={collection} />

                <!-- Comments -->
                <Comments path={walinePath} />
            </article>
        </main>
    </div>
</BaseLayout>

<style>
    .post-page {
        display: flex;
        justify-content: center;
        gap: 2rem;
        padding-top: 0;
    }

    /* Main content column */
    main.container {
        flex: 1;
        min-width: 0;
        max-width: var(--content-width);
    }

    /* Post header */
    .post-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border);
    }

    .post-title {
        font-size: 1.875rem;
        font-weight: 700;
        line-height: 1.3;
        margin-bottom: 0.75rem;
        color: var(--text);
    }

    .post-meta-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
    }

    .post-tags-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .post-stats {
        margin-bottom: 0.9rem;
        color: var(--text-muted);
        font-size: 0.95rem;
        font-style: italic;
    }

    .post-stats-line {
        margin: 0.1rem 0;
    }

    /* Mobile TOC */
    .mobile-toc {
        display: none;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 1.5rem;
        background: var(--bg-card);
    }

    .mobile-toc summary {
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        color: var(--text);
        list-style: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .mobile-toc summary::before {
        content: "▶";
        font-size: 0.65rem;
        transition: transform 150ms ease;
    }

    .mobile-toc[open] summary::before {
        transform: rotate(90deg);
    }

    /* Desktop TOC sidebar */
    .toc-sidebar {
        display: none;
        width: 220px;
        flex-shrink: 0;
        position: sticky;
        top: calc(var(--header-height) + 2rem);
        max-height: calc(100vh - var(--header-height) - 4rem);
        overflow-y: auto;
        align-self: flex-start;
    }

    @media (min-width: 1100px) {
        .toc-sidebar {
            display: block;
        }
    }

    @media (max-width: 1099px) {
        .mobile-toc {
            display: block;
        }
    }
</style>
