---
import { getCollection } from "astro:content";
import { SITE_TITLE } from "../consts";
import { getDefaultUiText } from "../i18n/ui";
import BaseLayout from "../layouts/BaseLayout.astro";
import { getPostDateKey, resolvePostDatesMap } from "../utils/post-dates";

const posts = await getCollection("blog", ({ data }) => !data.hidden);
const postDatesMap = await resolvePostDatesMap(posts);

// Collect all tags with counts
const tagCounts: Record<string, number> = {};
for (const post of posts) {
    for (const tag of (post.data.tags || [])) {
        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
    }
}
const tags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);

function formatDateTime(date: Date): string {
    const yyyy = date.getFullYear();
    const mm = String(date.getMonth() + 1).padStart(2, "0");
    const dd = String(date.getDate()).padStart(2, "0");
    const hh = String(date.getHours()).padStart(2, "0");
    const min = String(date.getMinutes()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
}
---

<BaseLayout title={`${getDefaultUiText("tags.metaTitle")} | ${SITE_TITLE}`}>
    <main>
        <div class="container">
            <nav class="breadcrumb" data-i18n-aria-label="post.breadcrumbAria" aria-label={getDefaultUiText("post.breadcrumbAria")}>
                <a href="/" data-i18n="common.home">{getDefaultUiText("common.home")}</a>
                <span class="breadcrumb-sep">/</span>
                <span data-i18n="tags.title">{getDefaultUiText("tags.title")}</span>
            </nav>

            <h1 class="section-heading">
                <span data-i18n="tags.title">{getDefaultUiText("tags.title")}</span>
                <span class="text-muted text-sm">({tags.length} <span data-i18n="tags.countUnit">{getDefaultUiText("tags.countUnit")}</span>)</span>
            </h1>

            <div class="tag-cloud">
                {tags.map(([tag, count]) => (
                    <a href={`#${tag}`} class="tag-item">
                        #{tag}
                        <span class="tag-count">{count}</span>
                    </a>
                ))}
            </div>

            <!-- Posts grouped by tag -->
            {tags.map(([tag]) => {
                const tagPosts = posts
                    .filter(p => p.data.tags?.includes(tag))
                    .sort((a, b) => {
                        const aDate = postDatesMap.get(getPostDateKey(a))?.pubDate ?? a.data.pubDate;
                        const bDate = postDatesMap.get(getPostDateKey(b))?.pubDate ?? b.data.pubDate;
                        return bDate.valueOf() - aDate.valueOf();
                    });
                return (
                    <section id={tag} class="tag-section">
                        <h2 class="tag-section-title">#{tag} <span class="text-muted text-sm">({tagPosts.length})</span></h2>
                        <ul class="archive-list">
                            {tagPosts.map((post) => {
                                const url = `/posts/${post.id}`;
                                const resolvedPubDate =
                                    postDatesMap.get(getPostDateKey(post))?.pubDate ?? post.data.pubDate;
                                const dateStr = formatDateTime(resolvedPubDate);
                                return (
                                    <li class="archive-item">
                                        <span class="archive-date">{dateStr}</span>
                                        <a href={url} class="archive-title">{post.data.title}</a>
                                    </li>
                                );
                            })}
                        </ul>
                    </section>
                );
            })}
        </div>
    </main>
</BaseLayout>

<style>
    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 2.5rem;
    }

    .tag-item {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.75rem;
        border-radius: 9999px;
        border: 1px solid var(--border);
        background: var(--bg-card);
        color: var(--text-muted);
        font-size: 0.875rem;
        text-decoration: none;
        transition: border-color 150ms ease, color 150ms ease;
    }

    .tag-item:hover {
        border-color: var(--accent);
        color: var(--accent);
    }

    .tag-count {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .tag-section {
        margin-bottom: 2rem;
    }

    .tag-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        padding-bottom: 0.4rem;
        border-bottom: 1px solid var(--border);
    }

    .archive-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .archive-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.4rem 0;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
    }

    .archive-item:last-child {
        border-bottom: none;
    }

    .archive-date {
        color: var(--text-muted);
        font-size: 0.8125rem;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .archive-title {
        color: var(--text);
        text-decoration: none;
        flex: 1;
        transition: color 150ms ease;
    }

    .archive-title:hover {
        color: var(--accent);
    }
</style>
