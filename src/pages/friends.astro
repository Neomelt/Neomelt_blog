---
import { SITE_TITLE } from "../consts";
import { FRIEND_LINKS } from "../data/friends";
import { getDefaultUiText } from "../i18n/ui";
import BaseLayout from "../layouts/BaseLayout.astro";
import Comments from "../components/Comments.astro";
import { getFriendCirclePosts } from "../utils/friend-circle";
import { normalizeWalinePath } from "../utils/waline";

const walinePath = normalizeWalinePath("/friends");
const friendLinks = FRIEND_LINKS;
const friendCirclePosts = await getFriendCirclePosts(friendLinks, {
    perFeedLimit: 6,
    totalLimit: 30,
    timeoutMs: 8000,
});
---

<BaseLayout
    title={`${getDefaultUiText("friends.metaTitle")} | ${SITE_TITLE}`}
    description={getDefaultUiText("friends.metaDescription")}
>
    <main>
        <div class="container">
            <nav class="breadcrumb" data-i18n-aria-label="post.breadcrumbAria" aria-label={getDefaultUiText("post.breadcrumbAria")}>
                <a href="/" data-i18n="common.home">{getDefaultUiText("common.home")}</a>
                <span>›</span>
                <span data-i18n="friends.pageCrumb">{getDefaultUiText("friends.pageCrumb")}</span>
            </nav>

            <header class="friends-header">
                <h1 data-i18n="friends.title">{getDefaultUiText("friends.title")}</h1>
                <p class="friends-lead" data-i18n="friends.lead">{getDefaultUiText("friends.lead")}</p>
                <p class="friends-stats">
                    <span class="waline-pageview-count waline-pageview-update" data-path={walinePath}>0</span> <span data-i18n="common.views">{getDefaultUiText("common.views")}</span> /
                    <span class="waline-comment-count" data-path={walinePath}>0</span> <span data-i18n="common.messages">{getDefaultUiText("common.messages")}</span>
                </p>
            </header>

            <section class="friends-section" aria-labelledby="friends-circle-title">
                <h2 id="friends-circle-title" data-i18n="friends.circleTitle">{getDefaultUiText("friends.circleTitle")}</h2>
                <p class="section-desc" data-i18n="friends.circleLead">{getDefaultUiText("friends.circleLead")}</p>
                <p class="friends-circle-tip" data-i18n="friends.circleHint">{getDefaultUiText("friends.circleHint")}</p>
                {friendCirclePosts.length > 0 ? (
                    <ul class="circle-list">
                        {friendCirclePosts.map((post) => (
                            <li class="circle-item">
                                <a href={post.link} target="_blank" rel="noopener noreferrer" class="circle-link">
                                    {post.friendAvatar ? (
                                        <img src={post.friendAvatar} alt={post.friendName} class="circle-avatar" loading="lazy" />
                                    ) : (
                                        <span class="circle-avatar circle-avatar-placeholder" aria-hidden="true">
                                            {post.friendName.slice(0, 1)}
                                        </span>
                                    )}
                                    <div class="circle-main">
                                        <p class="circle-title">{post.title}</p>
                                        <p class="circle-source">
                                            <span>{post.friendName}</span>
                                            {post.publishedDate && (
                                                <>
                                                    <span class="circle-separator">·</span>
                                                    <time datetime={post.publishedISO}>{post.publishedDate}</time>
                                                </>
                                            )}
                                        </p>
                                    </div>
                                </a>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <div class="empty-state" data-i18n="friends.circleEmpty">{getDefaultUiText("friends.circleEmpty")}</div>
                )}
            </section>

            <section class="friends-section" aria-labelledby="friends-list-title">
                <h2 id="friends-list-title" data-i18n="friends.listTitle">{getDefaultUiText("friends.listTitle")}</h2>
                {friendLinks.length > 0 ? (
                    <ul class="friends-grid">
                        {friendLinks.map((link) => (
                            <li class="friend-card">
                                <a
                                    href={link.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="friend-link"
                                >
                                    {link.avatar ? (
                                        <img
                                            src={link.avatar}
                                            alt={link.name}
                                            class="friend-avatar"
                                            loading="lazy"
                                        />
                                    ) : (
                                        <span class="friend-avatar friend-avatar-placeholder" aria-hidden="true">
                                            {link.name.slice(0, 1)}
                                        </span>
                                    )}
                                    <div class="friend-meta">
                                        <h3>{link.name}</h3>
                                        <p>{link.description}</p>
                                        {link.tags && link.tags.length > 0 && (
                                            <div class="friend-tags">
                                                {link.tags.map((tag) => (
                                                    <span class="friend-tag">{tag}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </a>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <div class="empty-state" data-i18n="friends.empty">{getDefaultUiText("friends.empty")}</div>
                )}
            </section>

            <section class="friends-section" aria-labelledby="friends-apply-title">
                <h2 id="friends-apply-title" data-i18n="friends.applyTitle">{getDefaultUiText("friends.applyTitle")}</h2>
                <p class="section-desc" data-i18n="friends.applyDesc">{getDefaultUiText("friends.applyDesc")}</p>
                <div class="apply-actions">
                    <a href="mailto:3212929002@qq.com" class="apply-btn apply-btn-primary" data-i18n="friends.applyEmail">{getDefaultUiText("friends.applyEmail")}</a>
                    <a
                        href="https://github.com/Neomelt/Neomelt_blog/issues"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="apply-btn apply-btn-secondary"
                    >
                        GitHub Issue
                    </a>
                </div>

                <div class="apply-template">
                    <h3 data-i18n="friends.infoTitle">{getDefaultUiText("friends.infoTitle")}</h3>
                    <ul>
                        <li data-i18n="friends.infoName">{getDefaultUiText("friends.infoName")}</li>
                        <li data-i18n="friends.infoUrl">{getDefaultUiText("friends.infoUrl")}</li>
                        <li data-i18n="friends.infoDesc">{getDefaultUiText("friends.infoDesc")}</li>
                        <li data-i18n="friends.infoAvatar">{getDefaultUiText("friends.infoAvatar")}</li>
                    </ul>
                </div>
            </section>

            <Comments path={walinePath} />
        </div>
    </main>
</BaseLayout>

<style>
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 2rem;
    }

    .breadcrumb a {
        color: var(--text-muted);
        text-decoration: none;
        transition: color var(--transition);
    }

    .breadcrumb a:hover {
        color: var(--accent);
    }

    .friends-header {
        margin-bottom: 1.5rem;
    }

    .friends-header h1 {
        margin-bottom: 0.5rem;
        font-size: clamp(1.8rem, 2.6vw, 2.3rem);
    }

    .friends-lead {
        margin-bottom: 0.3rem;
        color: var(--text-muted);
    }

    .friends-stats {
        margin-top: 0;
        margin-bottom: 0.5rem;
        color: var(--text-muted);
        font-size: 0.95rem;
        font-style: italic;
        line-height: 1.6;
    }

    .friends-section {
        margin-top: 1.25rem;
        padding: 1.25rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--bg-card);
    }

    .friends-section h2 {
        margin: 0 0 0.6rem;
        font-size: 1.2rem;
    }

    .section-desc {
        margin-bottom: 1rem;
        color: var(--text-muted);
    }

    .friends-circle-tip {
        margin-top: -0.3rem;
        margin-bottom: 1rem;
        color: var(--text-muted);
        font-size: 0.88rem;
    }

    .circle-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.62rem;
    }

    .circle-item {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg);
        transition: border-color var(--transition), transform var(--transition);
    }

    .circle-item:hover {
        transform: translateY(-1px);
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
    }

    .circle-link {
        display: flex;
        align-items: center;
        gap: 0.72rem;
        padding: 0.74rem 0.86rem;
        color: inherit;
        text-decoration: none;
    }

    .circle-link:hover {
        color: inherit;
    }

    .circle-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid var(--border);
        object-fit: cover;
        flex-shrink: 0;
    }

    .circle-avatar-placeholder {
        display: grid;
        place-items: center;
        color: var(--accent);
        font-weight: 700;
        background: var(--bg-card);
    }

    .circle-main {
        min-width: 0;
        flex: 1;
    }

    .circle-title {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.4;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .circle-source {
        margin: 0.16rem 0 0;
        font-size: 0.8rem;
        line-height: 1.3;
        color: var(--text-muted);
    }

    .circle-separator {
        margin: 0 0.36rem;
    }

    .friends-grid {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.9rem;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .friend-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg);
        transition: border-color var(--transition), transform var(--transition);
    }

    .friend-card:hover {
        transform: translateY(-1px);
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
    }

    .friend-link {
        display: flex;
        gap: 0.75rem;
        padding: 0.9rem;
        text-decoration: none;
        color: inherit;
    }

    .friend-link:hover {
        color: inherit;
    }

    .friend-avatar {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        border: 1px solid var(--border);
        object-fit: cover;
        flex-shrink: 0;
    }

    .friend-avatar-placeholder {
        display: grid;
        place-items: center;
        font-weight: 700;
        color: var(--accent);
        background: var(--bg-code);
    }

    .friend-meta h3 {
        margin: 0 0 0.25rem;
        font-size: 1.05rem;
        line-height: 1.3;
    }

    .friend-meta p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.94rem;
        line-height: 1.5;
    }

    .friend-tags {
        margin-top: 0.45rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .friend-tag {
        font-size: 0.76rem;
        line-height: 1;
        padding: 0.3rem 0.5rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--text-muted);
        background: var(--bg-card);
    }

    .empty-state {
        padding: 1rem;
        border-radius: 10px;
        border: 1px dashed var(--border);
        color: var(--text-muted);
        background: var(--bg-code);
    }

    .apply-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
        margin-bottom: 1rem;
    }

    .apply-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.52rem 0.92rem;
        border-radius: 8px;
        border: 1px solid transparent;
        font-weight: 600;
        text-decoration: none;
        transition: background var(--transition), border-color var(--transition), color var(--transition);
    }

    .apply-btn-primary {
        background: var(--accent);
        color: #fff;
    }

    .apply-btn-primary:hover {
        background: var(--accent-hover);
        color: #fff;
    }

    .apply-btn-secondary {
        border-color: var(--border);
        background: var(--bg);
        color: var(--text);
    }

    .apply-btn-secondary:hover {
        border-color: var(--accent);
        color: var(--accent);
    }

    .apply-template {
        border-top: 1px dashed var(--border);
        padding-top: 0.9rem;
    }

    .apply-template h3 {
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .apply-template ul {
        margin: 0;
        padding-left: 1.25rem;
        color: var(--text-muted);
    }

    .apply-template li {
        margin-bottom: 0.35rem;
    }

    @media (max-width: 640px) {
        .friends-section {
            padding: 1rem;
        }

        .circle-link {
            padding: 0.68rem 0.72rem;
        }

        .circle-avatar {
            width: 34px;
            height: 34px;
        }

        .friend-link {
            padding: 0.8rem;
        }

        .friend-avatar {
            width: 46px;
            height: 46px;
        }
    }
</style>
