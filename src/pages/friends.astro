---
import { SITE_TITLE } from "../consts";
import { FRIEND_LINKS } from "../data/friends";
import { getDefaultUiText } from "../i18n/ui";
import BaseLayout from "../layouts/BaseLayout.astro";
import Comments from "../components/Comments.astro";
import { getFriendCirclePosts } from "../utils/friend-circle";
import { normalizeWalinePath } from "../utils/waline";

const walinePath = normalizeWalinePath("/friends");
const friendLinks = FRIEND_LINKS;
const friendCirclePosts = await getFriendCirclePosts(friendLinks, {
    perFeedLimit: 6,
    totalLimit: 30,
    timeoutMs: 8000,
});

const myFriendLinkInfo = {
    name: "Neomelt's Blog",
    desc: "Keep looking, don't settle",
    link: "https://neomelt.cloud",
    avatar: "https://www.neomelt.cloud/head.jpg",
    rss: "https://www.neomelt.cloud/rss.xml",
};

const myFriendLinkItems = [
    { label: "Name", value: myFriendLinkInfo.name },
    { label: "Desc", value: myFriendLinkInfo.desc },
    { label: "Link", value: myFriendLinkInfo.link },
    { label: "Avatar", value: myFriendLinkInfo.avatar },
    { label: "RSS", value: myFriendLinkInfo.rss },
];

const myFriendLinkText = myFriendLinkItems
    .map((item) => `${item.label}: ${item.value}`)
    .join("\n");
---

<BaseLayout
    title={`${getDefaultUiText("friends.metaTitle")} | ${SITE_TITLE}`}
    description={getDefaultUiText("friends.metaDescription")}
>
    <main>
        <div class="container">
            <nav class="breadcrumb" data-i18n-aria-label="post.breadcrumbAria" aria-label={getDefaultUiText("post.breadcrumbAria")}>
                <a href="/" data-i18n="common.home">{getDefaultUiText("common.home")}</a>
                <span>›</span>
                <span data-i18n="friends.pageCrumb">{getDefaultUiText("friends.pageCrumb")}</span>
            </nav>

            <header class="friends-header">
                <h1 data-i18n="friends.title">{getDefaultUiText("friends.title")}</h1>
                <p class="friends-lead" data-i18n="friends.lead">{getDefaultUiText("friends.lead")}</p>
                <p class="friends-stats">
                    <span class="waline-pageview-count waline-pageview-update" data-path={walinePath}>0</span> <span data-i18n="common.views">{getDefaultUiText("common.views")}</span> /
                    <span class="waline-comment-count" data-path={walinePath}>0</span> <span data-i18n="common.messages">{getDefaultUiText("common.messages")}</span>
                </p>
            </header>

            <section class="friends-section" aria-labelledby="friends-circle-title">
                <h2 id="friends-circle-title" data-i18n="friends.circleTitle">{getDefaultUiText("friends.circleTitle")}</h2>
                <p class="section-desc" data-i18n="friends.circleLead">{getDefaultUiText("friends.circleLead")}</p>
                <p class="friends-circle-tip" data-i18n="friends.circleHint">{getDefaultUiText("friends.circleHint")}</p>
                {friendCirclePosts.length > 0 ? (
                    <ul class="circle-list">
                        {friendCirclePosts.map((post) => (
                            <li class="circle-item">
                                <a href={post.link} target="_blank" rel="noopener noreferrer" class="circle-link">
                                    {post.friendAvatar ? (
                                        <img src={post.friendAvatar} alt={post.friendName} class="circle-avatar" loading="lazy" />
                                    ) : (
                                        <span class="circle-avatar circle-avatar-placeholder" aria-hidden="true">
                                            {post.friendName.slice(0, 1)}
                                        </span>
                                    )}
                                    <div class="circle-main">
                                        <p class="circle-title">{post.title}</p>
                                        <p class="circle-source">
                                            <span>{post.friendName}</span>
                                            {post.publishedDate && (
                                                <>
                                                    <span class="circle-separator">·</span>
                                                    <time datetime={post.publishedISO}>{post.publishedDate}</time>
                                                </>
                                            )}
                                        </p>
                                    </div>
                                </a>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <div class="empty-state" data-i18n="friends.circleEmpty">{getDefaultUiText("friends.circleEmpty")}</div>
                )}
            </section>

            <section class="friends-section" aria-labelledby="friends-list-title">
                <h2 id="friends-list-title" data-i18n="friends.listTitle">{getDefaultUiText("friends.listTitle")}</h2>
                {friendLinks.length > 0 ? (
                    <ul class="friends-grid">
                        {friendLinks.map((link) => (
                            <li class="friend-card">
                                <a
                                    href={link.url}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="friend-link"
                                >
                                    {link.avatar ? (
                                        <img
                                            src={link.avatar}
                                            alt={link.name}
                                            class="friend-avatar"
                                            loading="lazy"
                                        />
                                    ) : (
                                        <span class="friend-avatar friend-avatar-placeholder" aria-hidden="true">
                                            {link.name.slice(0, 1)}
                                        </span>
                                    )}
                                    <div class="friend-meta">
                                        <h3>{link.name}</h3>
                                        <p>{link.description}</p>
                                        {link.tags && link.tags.length > 0 && (
                                            <div class="friend-tags">
                                                {link.tags.map((tag) => (
                                                    <span class="friend-tag">{tag}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </a>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <div class="empty-state" data-i18n="friends.empty">{getDefaultUiText("friends.empty")}</div>
                )}
            </section>

            <section class="friends-section" aria-labelledby="friends-apply-title">
                <h2 id="friends-apply-title" data-i18n="friends.applyTitle">{getDefaultUiText("friends.applyTitle")}</h2>
                <p class="section-desc" data-i18n="friends.applyDesc">{getDefaultUiText("friends.applyDesc")}</p>

                <div class="self-link-card">
                    <div class="self-link-head">
                        <h3 data-i18n="friends.selfInfoTitle">{getDefaultUiText("friends.selfInfoTitle")}</h3>
                        <button
                            type="button"
                            class="copy-action copy-all-btn"
                            data-copy-text={myFriendLinkText}
                            data-copy-default={getDefaultUiText("friends.copyAll")}
                            data-copy-success={getDefaultUiText("friends.copied")}
                        >
                            <span class="copy-btn-icon" aria-hidden="true">⎘</span>
                            <span data-copy-label data-i18n="friends.copyAll">{getDefaultUiText("friends.copyAll")}</span>
                        </button>
                    </div>
                    <p class="self-link-desc" data-i18n="friends.selfInfoDesc">{getDefaultUiText("friends.selfInfoDesc")}</p>
                    <ul class="self-link-list">
                        {myFriendLinkItems.map((item) => (
                            <li>
                                <button
                                    type="button"
                                    class="self-link-row copy-action"
                                    data-copy-text={`${item.label}: ${item.value}`}
                                    data-copy-default={getDefaultUiText("friends.copy")}
                                    data-copy-success={getDefaultUiText("friends.copied")}
                                >
                                    <span class="self-link-label">{item.label}</span>
                                    <code class="self-link-value">{item.value}</code>
                                    <span class="self-link-copy" data-copy-label data-i18n="friends.copy">{getDefaultUiText("friends.copy")}</span>
                                </button>
                            </li>
                        ))}
                    </ul>
                </div>

                <div class="apply-actions">
                    <a href="mailto:3212929002@qq.com" class="apply-btn apply-btn-primary">
                        <span class="apply-btn-icon" aria-hidden="true">✉</span>
                        <span data-i18n="friends.applyEmail">{getDefaultUiText("friends.applyEmail")}</span>
                    </a>
                    <a
                        href="https://github.com/Neomelt/Neomelt_blog/issues"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="apply-btn apply-btn-secondary"
                    >
                        <span class="apply-btn-icon" aria-hidden="true">⌁</span>
                        <span>GitHub Issue</span>
                    </a>
                </div>

                <div class="apply-template">
                    <h3 data-i18n="friends.infoTitle">{getDefaultUiText("friends.infoTitle")}</h3>
                    <ul>
                        <li data-i18n="friends.infoName">{getDefaultUiText("friends.infoName")}</li>
                        <li data-i18n="friends.infoUrl">{getDefaultUiText("friends.infoUrl")}</li>
                        <li data-i18n="friends.infoDesc">{getDefaultUiText("friends.infoDesc")}</li>
                        <li data-i18n="friends.infoAvatar">{getDefaultUiText("friends.infoAvatar")}</li>
                    </ul>
                </div>
            </section>

            <Comments path={walinePath} />
        </div>
    </main>
</BaseLayout>

<style>
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 2rem;
    }

    .breadcrumb a {
        color: var(--text-muted);
        text-decoration: none;
        transition: color var(--transition);
    }

    .breadcrumb a:hover {
        color: var(--accent);
    }

    .friends-header {
        margin-bottom: 1.5rem;
    }

    .friends-header h1 {
        margin-bottom: 0.5rem;
        font-size: clamp(1.8rem, 2.6vw, 2.3rem);
    }

    .friends-lead {
        margin-bottom: 0.3rem;
        color: var(--text-muted);
    }

    .friends-stats {
        margin-top: 0;
        margin-bottom: 0.5rem;
        color: var(--text-muted);
        font-size: 0.95rem;
        font-style: italic;
        line-height: 1.6;
    }

    .friends-section {
        margin-top: 1.25rem;
        padding: 1.25rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--bg-card);
    }

    .friends-section h2 {
        margin: 0 0 0.6rem;
        font-size: 1.2rem;
    }

    .section-desc {
        margin-bottom: 1rem;
        color: var(--text-muted);
    }

    .friends-circle-tip {
        margin-top: -0.3rem;
        margin-bottom: 1rem;
        color: var(--text-muted);
        font-size: 0.88rem;
    }

    .circle-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.62rem;
    }

    .circle-item {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg);
        transition: border-color var(--transition), transform var(--transition);
    }

    .circle-item:hover {
        transform: translateY(-1px);
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
    }

    .circle-link {
        display: flex;
        align-items: center;
        gap: 0.72rem;
        padding: 0.74rem 0.86rem;
        color: inherit;
        text-decoration: none;
    }

    .circle-link:hover {
        color: inherit;
    }

    .circle-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid var(--border);
        object-fit: cover;
        flex-shrink: 0;
    }

    .circle-avatar-placeholder {
        display: grid;
        place-items: center;
        color: var(--accent);
        font-weight: 700;
        background: var(--bg-card);
    }

    .circle-main {
        min-width: 0;
        flex: 1;
    }

    .circle-title {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.4;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .circle-source {
        margin: 0.16rem 0 0;
        font-size: 0.8rem;
        line-height: 1.3;
        color: var(--text-muted);
    }

    .circle-separator {
        margin: 0 0.36rem;
    }

    .friends-grid {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        gap: 0.9rem;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }

    .friend-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg);
        transition: border-color var(--transition), transform var(--transition);
    }

    .friend-card:hover {
        transform: translateY(-1px);
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
    }

    .friend-link {
        display: flex;
        gap: 0.75rem;
        padding: 0.9rem;
        text-decoration: none;
        color: inherit;
    }

    .friend-link:hover {
        color: inherit;
    }

    .friend-avatar {
        width: 52px;
        height: 52px;
        border-radius: 12px;
        border: 1px solid var(--border);
        object-fit: cover;
        flex-shrink: 0;
    }

    .friend-avatar-placeholder {
        display: grid;
        place-items: center;
        font-weight: 700;
        color: var(--accent);
        background: var(--bg-code);
    }

    .friend-meta h3 {
        margin: 0 0 0.25rem;
        font-size: 1.05rem;
        line-height: 1.3;
    }

    .friend-meta p {
        margin: 0;
        color: var(--text-muted);
        font-size: 0.94rem;
        line-height: 1.5;
    }

    .friend-tags {
        margin-top: 0.45rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
    }

    .friend-tag {
        font-size: 0.76rem;
        line-height: 1;
        padding: 0.3rem 0.5rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        color: var(--text-muted);
        background: var(--bg-card);
    }

    .empty-state {
        padding: 1rem;
        border-radius: 10px;
        border: 1px dashed var(--border);
        color: var(--text-muted);
        background: var(--bg-code);
    }

    .self-link-card {
        margin-bottom: 1rem;
        padding: 0.95rem;
        border: 1px solid color-mix(in srgb, var(--accent) 25%, var(--border));
        border-radius: 11px;
        background: linear-gradient(
            135deg,
            color-mix(in srgb, var(--accent) 9%, var(--bg-card)) 0%,
            var(--bg) 100%
        );
    }

    .self-link-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 0.35rem;
    }

    .self-link-head h3 {
        margin: 0;
        font-size: 1rem;
    }

    .self-link-desc {
        margin: 0 0 0.72rem;
        color: var(--text-muted);
        font-size: 0.86rem;
        line-height: 1.5;
    }

    .self-link-list {
        margin: 0;
        padding: 0;
        list-style: none;
        display: grid;
        gap: 0.42rem;
    }

    .self-link-row {
        width: 100%;
        display: grid;
        grid-template-columns: 56px 1fr auto;
        align-items: center;
        gap: 0.62rem;
        padding: 0.56rem 0.68rem;
        border: 1px solid var(--border);
        border-radius: 9px;
        background: var(--bg);
        color: inherit;
        text-align: left;
        cursor: pointer;
        transition: border-color var(--transition), background var(--transition), transform var(--transition);
    }

    .self-link-row:hover {
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
        transform: translateY(-1px);
    }

    .self-link-row:focus-visible {
        outline: 2px solid color-mix(in srgb, var(--accent) 70%, #fff);
        outline-offset: 2px;
    }

    .self-link-label {
        font-size: 0.84rem;
        color: var(--text-muted);
    }

    .self-link-value {
        min-width: 0;
        font-size: 0.82rem;
        line-height: 1.4;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .self-link-copy {
        padding: 0.18rem 0.5rem;
        border: 1px solid var(--border);
        border-radius: 999px;
        font-size: 0.74rem;
        color: var(--text-muted);
        background: var(--bg-card);
        white-space: nowrap;
    }

    .copy-all-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 0.3rem 0.7rem;
        background: var(--bg);
        color: var(--text);
        cursor: pointer;
        transition: border-color var(--transition), color var(--transition), background var(--transition);
    }

    .copy-all-btn:hover {
        border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
        color: var(--accent);
    }

    .copy-btn-icon {
        font-size: 0.78rem;
    }

    .copy-action[data-copied="true"] {
        border-color: color-mix(in srgb, var(--accent) 66%, var(--border));
    }

    .copy-action[data-copied="true"] [data-copy-label] {
        color: var(--accent);
    }

    .apply-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .apply-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.42rem;
        min-width: 150px;
        padding: 0.64rem 1.02rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-weight: 700;
        font-size: 0.94rem;
        letter-spacing: 0.01em;
        text-decoration: none;
        box-shadow: 0 7px 18px rgba(0, 0, 0, 0.18);
        transition:
            transform var(--transition),
            background var(--transition),
            border-color var(--transition),
            color var(--transition),
            box-shadow var(--transition);
    }

    .apply-btn-primary {
        background: linear-gradient(
            135deg,
            color-mix(in srgb, var(--accent) 92%, #fff) 0%,
            color-mix(in srgb, var(--accent-hover) 85%, #111) 100%
        );
        border-color: color-mix(in srgb, var(--accent) 75%, var(--border));
        color: #fff;
    }

    .apply-btn-primary:hover {
        background: linear-gradient(
            135deg,
            color-mix(in srgb, var(--accent-hover) 95%, #fff) 0%,
            color-mix(in srgb, var(--accent-hover) 90%, #111) 100%
        );
        color: #fff;
        transform: translateY(-1px);
        box-shadow: 0 11px 24px rgba(0, 0, 0, 0.24);
    }

    .apply-btn-secondary {
        background: linear-gradient(
            135deg,
            color-mix(in srgb, var(--bg-card) 80%, #000) 0%,
            var(--bg) 100%
        );
        color: var(--text);
    }

    .apply-btn-secondary:hover {
        border-color: var(--accent);
        color: var(--accent);
        transform: translateY(-1px);
        box-shadow: 0 11px 24px rgba(0, 0, 0, 0.24);
    }

    .apply-btn:focus-visible {
        outline: 2px solid color-mix(in srgb, var(--accent) 70%, #fff);
        outline-offset: 2px;
    }

    .apply-btn-icon {
        font-size: 0.88rem;
        line-height: 1;
    }

    .apply-template {
        border-top: 1px dashed var(--border);
        padding-top: 0.9rem;
    }

    .apply-template h3 {
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .apply-template ul {
        margin: 0;
        padding-left: 1.25rem;
        color: var(--text-muted);
    }

    .apply-template li {
        margin-bottom: 0.35rem;
    }

    @media (max-width: 640px) {
        .friends-section {
            padding: 1rem;
        }

        .self-link-card {
            padding: 0.8rem;
        }

        .self-link-head {
            align-items: flex-start;
            flex-direction: column;
        }

        .self-link-row {
            grid-template-columns: 52px 1fr;
        }

        .self-link-copy {
            grid-column: 2;
            justify-self: start;
            margin-top: 0.16rem;
        }

        .circle-link {
            padding: 0.68rem 0.72rem;
        }

        .circle-avatar {
            width: 34px;
            height: 34px;
        }

        .friend-link {
            padding: 0.8rem;
        }

        .friend-avatar {
            width: 46px;
            height: 46px;
        }

        .friends-grid {
            grid-template-columns: 1fr;
        }

        .circle-link {
            align-items: flex-start;
        }

        .circle-title {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }

        .apply-actions {
            flex-direction: column;
        }

        .apply-btn {
            width: 100%;
            min-width: 0;
        }
    }

    @media (max-width: 420px) {
        .self-link-row {
            grid-template-columns: 1fr;
            gap: 0.35rem;
        }

        .self-link-copy {
            grid-column: 1;
            margin-top: 0;
        }
    }
</style>

<script>
    async function fallbackCopy(text) {
        const helper = document.createElement("textarea");
        helper.value = text;
        helper.setAttribute("readonly", "readonly");
        helper.style.position = "fixed";
        helper.style.opacity = "0";
        document.body.appendChild(helper);
        helper.select();
        document.execCommand("copy");
        document.body.removeChild(helper);
    }

    async function copyText(text) {
        if (!text) return false;
        try {
            if (navigator?.clipboard?.writeText) {
                await navigator.clipboard.writeText(text);
            } else {
                await fallbackCopy(text);
            }
            return true;
        } catch {
            try {
                await fallbackCopy(text);
                return true;
            } catch {
                return false;
            }
        }
    }

    function bindCopyActions() {
        const copyButtons = document.querySelectorAll(".copy-action");
        copyButtons.forEach((button) => {
            if (!(button instanceof HTMLElement)) return;
            if (button.dataset.copyBound === "1") return;
            button.dataset.copyBound = "1";
            button.addEventListener("click", async () => {
                const copyValue = button.getAttribute("data-copy-text") ?? "";
                const defaultLabel = button.getAttribute("data-copy-default") ?? "Copy";
                const successLabel = button.getAttribute("data-copy-success") ?? "Copied";
                const label = button.querySelector("[data-copy-label]");
                const copied = await copyText(copyValue);
                if (!copied) return;

                button.setAttribute("data-copied", "true");
                if (label) label.textContent = successLabel;
                window.setTimeout(() => {
                    button.setAttribute("data-copied", "false");
                    if (label) label.textContent = defaultLabel;
                }, 1200);
            });
        });
    }

    document.addEventListener("DOMContentLoaded", bindCopyActions);
    document.addEventListener("astro:page-load", bindCopyActions);
</script>
