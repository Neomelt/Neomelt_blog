---
import { type CollectionEntry, getCollection, render } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import FormattedDate from "../../components/FormattedDate.astro";
import Comments from "../../components/Comments.astro";
import TableOfContents from "../../components/TableOfContents.astro";
import PostNavigation from "../../components/PostNavigation.astro";
import { SITE_TITLE } from "../../consts";
import { getWalinePathForPost } from "../../utils/waline";

export async function getStaticPaths() {
    const zuegEntries = (await getCollection("zueg")).sort(
        (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
    );
    return zuegEntries.map((entry, index) => ({
        params: { slug: entry.id },
        props: {
            entry,
            prevPost: index < zuegEntries.length - 1 ? zuegEntries[index + 1] : null,
            nextPost: index > 0 ? zuegEntries[index - 1] : null,
        },
    }));
}

type Props = {
    entry: CollectionEntry<"zueg">;
    prevPost: CollectionEntry<"zueg"> | null;
    nextPost: CollectionEntry<"zueg"> | null;
};

const { entry, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(entry);
const walinePath = getWalinePathForPost(entry.id, "zueg");
---

<BaseLayout
    title={`${entry.data.title} | ${SITE_TITLE}`}
    description={entry.data.description || "随笔文章"}
>
    <div class="page-container">
        <div class="page-layout">
            <!-- 主内容区 -->
            <main class="main-content">
                <article>
                    <div class="prose">
                        <div class="title">
                            <div class="date">
                                <FormattedDate date={entry.data.pubDate} />
                                {entry.data.updatedDate && (
                                    <div class="last-updated-on">
                                        <span data-i18n="legacy.zueg.lastUpdated">最后更新于</span> <FormattedDate date={entry.data.updatedDate} />
                                    </div>
                                )}
                            </div>
                            <h1>{entry.data.title}</h1>
                            <div class="post-stats" data-i18n-aria-label="post.statsAria" aria-label="阅读和评论统计">
                                <p class="post-stats-line">
                                    <span class="waline-pageview-count" data-path={walinePath}>0</span> <span data-i18n="common.views">次浏览</span> /
                                    <span class="waline-comment-count" data-path={walinePath}>0</span> <span data-i18n="common.comments">条评论</span>
                                </p>
                            </div>
                            {entry.data.tags && (
                                <div class="tags">
                                    {entry.data.tags.map((tag) => (
                                        <span class="tag">#{tag}</span>
                                    ))}
                                </div>
                            )}
                            <hr />
                        </div>
                        <Content />
                    </div>

                    <!-- 上一篇/下一篇 导航 -->
                    <PostNavigation prevPost={prevPost} nextPost={nextPost} collection="zueg" />
                    
                    <!-- 评论区 -->
                    <Comments path={walinePath} />
                </article>
            </main>

            <!-- 目录 -->
            <aside class="page-sidebar">
                <TableOfContents headings={headings} />
            </aside>
        </div>
    </div>
</BaseLayout>

<style>
	.page-container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 2rem 1rem;
		padding-top: 6rem;
	}

	.page-layout {
		display: grid;
		grid-template-columns: 1fr 320px;
		gap: 3rem;
		align-items: start;
	}

	.main-content {
		min-width: 0;
	}

	.page-sidebar {
		position: sticky;
		top: 6rem;
	}

	main {
		width: 100%;
		max-width: 100%;
		margin: 0;
	}
	.prose {
		width: 100%;
		max-width: 100%;
		margin: auto;
		padding: clamp(1em, 3vw, 2em);
		color: rgb(var(--gray-dark));
		line-height: 1.8;
		font-size: 1.0625rem;
	}
	.title {
		margin-bottom: 1em;
		padding: 1em 0;
		text-align: center;
		line-height: 1;
	}
	.title h1 {
		margin: 0 0 0.5em 0;
	}
	.date {
		margin-bottom: 0.5em;
		color: rgb(var(--gray));
	}
	.last-updated-on {
		font-style: italic;
	}
	.post-stats {
		margin: 0.5em 0 0.9em;
		color: var(--text-muted);
		font-size: 0.95rem;
		font-style: italic;
		line-height: 1.5;
	}
	.post-stats-line {
		margin: 0.1rem 0;
	}
	.tags {
		margin: 0.5em 0;
		display: flex;
		flex-wrap: wrap;
		gap: 0.5em;
		justify-content: center;
	}
	.tag {
		padding: 0.25em 0.75em;
		font-size: 0.875rem;
		background-color: rgb(var(--accent-light));
		color: rgb(var(--accent-dark));
		border-radius: 999px;
	}

	@media (max-width: 1024px) {
		.page-layout {
			grid-template-columns: 1fr;
		}

		.page-sidebar {
			position: static;
			max-width: 600px;
			margin: 2rem auto 0;
		}
	}
</style>
