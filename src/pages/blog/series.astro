---
import { getCollection } from "astro:content";
import { SITE_TITLE } from "../../consts";
import BaseLayout from "../../layouts/BaseLayout.astro";
import ProfileCard from "../../components/ProfileCard.astro";
import Sidebar from "../../components/Sidebar.astro";
import { getDefaultUiText } from "../../i18n/ui";

// 获取所有博客文章
const posts = await getCollection("blog", ({ data }) => !data.hidden);

// 统计系列
const seriesCounts: Record<string, number> = {};
const seriesPosts: Record<string, typeof posts> = {};

posts.forEach((post) => {
    const series = post.data.series;
    if (series) {
        seriesCounts[series] = (seriesCounts[series] || 0) + 1;
        if (!seriesPosts[series]) {
            seriesPosts[series] = [];
        }
        seriesPosts[series].push(post);
    }
});

// 按文章数量排序
const sortedSeries = Object.entries(seriesCounts).sort(([, a], [, b]) => b - a);
---

<BaseLayout title={`${getDefaultUiText("legacy.series.title")} | ${SITE_TITLE}`}>
	<main>
		<div class="homepage-container">
			<div class="homepage-layout">
				<!-- 左侧：个人信息 + 侧边栏 -->
				<div class="homepage-sidebar">
					<ProfileCard />
					<Sidebar />
				</div>

				<!-- 右侧内容区 -->
				<div class="homepage-content">
					<h2 class="section-title" data-i18n="legacy.series.title">{getDefaultUiText("legacy.series.title")}</h2>
					<p class="text-lg mb-8 text-gray-700 dark:text-gray-300" data-i18n="legacy.series.desc">{getDefaultUiText("legacy.series.desc")}</p>

					{
						sortedSeries.length > 0 ? (
							<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
								{sortedSeries.map(([series, count]) => (
									<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md hover:shadow-lg transition border border-gray-200 dark:border-gray-700">
										<div class="flex items-center justify-between mb-4">
											<h3 class="text-xl font-bold text-gray-900 dark:text-white">
												{series}
											</h3>
											<span class="text-sm text-gray-500 dark:text-gray-400">
												{count} <span data-i18n="legacy.articlesSuffix">{getDefaultUiText("legacy.articlesSuffix")}</span>
											</span>
										</div>

										<div class="space-y-3">
											{seriesPosts[series]
												.sort((a, b) => {
													if (a.data.pinned && !b.data.pinned) return -1;
													if (!a.data.pinned && b.data.pinned) return 1;
													return a.data.pubDate.getTime() - b.data.pubDate.getTime();
												})
												.map((post, index) => (
													<div class="flex items-center">
														<span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded mr-2 min-w-[24px] text-center">
															{index + 1}
														</span>
														<a
															href={`/blog/${post.id}/`}
															class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 truncate flex-1"
														>
															{post.data.title}
														</a>
														{post.data.pinned && (
															<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-600 ml-1 flex-shrink-0"><path d="M12 17v5"/><path d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9c-.39.2-.1.75.33.75h11.12c.43 0 .72-.55.33-.75l-1.78-.9a2 2 0 0 1-1.11-1.79V7a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2Z"/></svg>
														)}
													</div>
												))}
										</div>
									</div>
								))}
							</div>
						) : (
							<div class="text-center py-12">
								<div class="text-gray-400 dark:text-gray-500 mb-4">
									<svg
										class="mx-auto h-12 w-12"
										fill="none"
										viewBox="0 0 24 24"
										stroke="currentColor"
									>
										<path
											stroke-linecap="round"
											stroke-linejoin="round"
											stroke-width="2"
											d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
										/>
									</svg>
								</div>
								<h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">
									<span data-i18n="legacy.series.emptyTitle">{getDefaultUiText("legacy.series.emptyTitle")}</span>
								</h3>
								<p class="text-gray-500 dark:text-gray-400" data-i18n="legacy.series.emptyDesc">{getDefaultUiText("legacy.series.emptyDesc")}</p>
							</div>
						)
					}
				</div>
			</div>
		</div>
	</main>
</BaseLayout>

<style>
	/* 首页容器 */
	.homepage-container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 2rem 1rem;
		padding-top: 6rem;
	}

	/* 首页布局 */
	.homepage-layout {
		display: grid;
		grid-template-columns: 320px 1fr;
		gap: 3rem;
	}

	/* 左侧边栏 */
	.homepage-sidebar {
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}

	/* 右侧内容区 */
	.homepage-content {
		min-width: 0;
	}

	/* 分类标题 */
	.section-title {
		font-size: 2rem;
		font-weight: 700;
		margin-bottom: 2rem;
		color: var(--text-primary);
	}

	/* 响应式设计 */
	@media (max-width: 1024px) {
		.homepage-layout {
			grid-template-columns: 1fr;
		}

		.homepage-sidebar {
			order: 2;
		}

		.homepage-content {
			order: 1;
		}
	}
</style>
