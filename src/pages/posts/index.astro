---
import { getCollection } from "astro:content";
import FormattedDate from "../../components/FormattedDate.astro";
import Pagination from "../../components/Pagination.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { paginate } from "../../utils/pagination.ts";
import { SITE_TITLE } from "../../consts";
import { getDefaultUiText } from "../../i18n/ui";
import { getWalinePathForPost } from "../../utils/waline";

// Merge blog + zueg, sort pinned first then by date
const blogPosts = await getCollection("blog");
const zuegPosts = await getCollection("zueg");

const allPosts = [...blogPosts, ...zuegPosts].sort((a, b) => {
    if (a.data.pinned && !b.data.pinned) return -1;
    if (!a.data.pinned && b.data.pinned) return 1;
    return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
});

const { items: paginatedPosts, pagination } = paginate(allPosts, 1, 10);

function estimateReadingTime(content: string): number {
    return Math.max(1, Math.ceil(content.length / 400));
}
---

<BaseLayout title={`${getDefaultUiText("posts.metaTitle")} | ${SITE_TITLE}`}>
    <main>
        <div class="container">
            <nav class="breadcrumb" data-i18n-aria-label="post.breadcrumbAria" aria-label={getDefaultUiText("post.breadcrumbAria")}>
                <a href="/" data-i18n="common.home">{getDefaultUiText("common.home")}</a>
                <span class="breadcrumb-sep">/</span>
                <span data-i18n="common.posts">{getDefaultUiText("common.posts")}</span>
            </nav>

            <h1 class="section-heading" data-i18n="posts.title">{getDefaultUiText("posts.title")}</h1>

            <div class="post-list">
                {paginatedPosts.map((post) => {
                    const isZueg = post.collection === "zueg";
                    const url = isZueg ? `/posts/zueg/${post.id}` : `/posts/${post.id}`;
                    const walinePath = getWalinePathForPost(post.id, isZueg ? "zueg" : "blog");
                    const readingTime = estimateReadingTime(post.body || "");
                    return (
                        <a href={url} class="post-card">
                            <div class="post-card-meta">
                                <FormattedDate date={post.data.pubDate} />
                                {isZueg && <span class="tag" data-i18n="common.essay">{getDefaultUiText("common.essay")}</span>}
                                {post.data.pinned && (
                                    <span class="badge-pinned" data-i18n="common.pinned">{getDefaultUiText("common.pinned")}</span>
                                )}
                                <span>{readingTime} <span data-i18n="common.minutes">{getDefaultUiText("common.minutes")}</span></span>
                            </div>
                            <div class="post-card-title">{post.data.title}</div>
                            {post.data.description && (
                                <div class="post-card-desc">{post.data.description}</div>
                            )}
                            <div class="post-card-stats text-muted text-sm">
                                <span class="waline-pageview-count" data-path={walinePath}>0</span> <span data-i18n="common.views">{getDefaultUiText("common.views")}</span> /
                                <span class="waline-comment-count" data-path={walinePath}>0</span> <span data-i18n="common.comments">{getDefaultUiText("common.comments")}</span>
                            </div>
                            {post.data.tags && post.data.tags.length > 0 && (
                                <div class="post-card-tags">
                                    {post.data.tags.slice(0, 4).map((tag: string) => (
                                        <span class="tag">#{tag}</span>
                                    ))}
                                </div>
                            )}
                        </a>
                    );
                })}
            </div>

            {allPosts.length === 0 && (
                <p class="text-muted" style="text-align:center;padding:3rem 0" data-i18n="posts.empty">{getDefaultUiText("posts.empty")}</p>
            )}

            {pagination.totalPages > 1 && (
                <Pagination pagination={pagination} basePath="/posts" />
            )}
        </div>
    </main>
</BaseLayout>
