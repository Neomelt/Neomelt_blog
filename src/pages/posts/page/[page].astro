---
import { getCollection, type CollectionEntry } from "astro:content";
import FormattedDate from "../../../components/FormattedDate.astro";
import Pagination from "../../../components/Pagination.astro";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { paginate } from "../../../utils/pagination.ts";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../../consts";
import { getWalinePathForPost } from "../../../utils/waline";

export async function getStaticPaths() {
    const blogPosts = await getCollection("blog");
    const zuegPosts = await getCollection("zueg");
    const allPosts = [...blogPosts, ...zuegPosts].sort((a, b) => {
        if (a.data.pinned && !b.data.pinned) return -1;
        if (!a.data.pinned && b.data.pinned) return 1;
        return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
    });

    const totalPages = Math.ceil(allPosts.length / 10) || 1;
    return Array.from({ length: totalPages }, (_, i) => ({
        params: { page: String(i + 2) },
        props: { allPosts },
    }));
}

interface Props {
    allPosts: (CollectionEntry<"blog"> | CollectionEntry<"zueg">)[];
}

const { page } = Astro.params;
const { allPosts } = Astro.props;
const currentPage = parseInt(page as string);
const { items: paginatedPosts, pagination } = paginate(allPosts, currentPage, 10);

function estimateReadingTime(content: string): number {
    return Math.max(1, Math.ceil(content.length / 400));
}
---

<BaseLayout title={`文章 第${page}页 | ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
    <main>
        <div class="container">
            <h1 class="section-heading">文章</h1>

            <div class="post-list">
                {paginatedPosts.map((post) => {
                    const isZueg = post.collection === "zueg";
                    const url = isZueg ? `/posts/zueg/${post.id}` : `/posts/${post.id}`;
                    const walinePath = getWalinePathForPost(post.id, isZueg ? "zueg" : "blog");
                    const readingTime = estimateReadingTime(post.body || "");
                    return (
                        <a href={url} class="post-card">
                            <div class="post-card-meta">
                                <FormattedDate date={post.data.pubDate} />
                                {isZueg && <span class="tag">随笔</span>}
                                {post.data.pinned && (
                                    <span class="badge-pinned">置顶</span>
                                )}
                                <span>{readingTime} 分钟</span>
                            </div>
                            <div class="post-card-title">{post.data.title}</div>
                            {post.data.description && (
                                <div class="post-card-desc">{post.data.description}</div>
                            )}
                            <div class="post-card-stats text-muted text-sm">
                                <span class="waline-pageview-count" data-path={walinePath}>0</span> views /
                                <span class="waline-comment-count" data-path={walinePath}>0</span> comments
                            </div>
                            {post.data.tags && post.data.tags.length > 0 && (
                                <div class="post-card-tags">
                                    {post.data.tags.slice(0, 4).map((tag: string) => (
                                        <span class="tag">#{tag}</span>
                                    ))}
                                </div>
                            )}
                        </a>
                    );
                })}
            </div>

            <Pagination pagination={pagination} basePath="/posts" />
        </div>
    </main>
</BaseLayout>
