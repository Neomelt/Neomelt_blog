---
import { getCollection } from "astro:content";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import BaseLayout from "../../layouts/BaseLayout.astro";

// Merge both collections
const blogPosts = await getCollection("blog");
const zuegPosts = await getCollection("zueg");
const allPosts = [...blogPosts, ...zuegPosts].sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Group by year
const byYear: Record<string, typeof allPosts> = {};
for (const post of allPosts) {
    const year = post.data.pubDate.getFullYear().toString();
    if (!byYear[year]) byYear[year] = [];
    byYear[year].push(post);
}
const years = Object.keys(byYear).sort((a, b) => parseInt(b) - parseInt(a));
---

<BaseLayout title={`归档 | ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
    <main>
        <div class="container">
            <nav class="breadcrumb" data-i18n-aria-label="post.breadcrumbAria" aria-label="面包屑">
                <a href="/" data-i18n="common.home">首页</a>
                <span class="breadcrumb-sep">/</span>
                <a href="/posts" data-i18n="common.posts">文章</a>
                <span class="breadcrumb-sep">/</span>
                <span data-i18n="archive.title">归档</span>
            </nav>

            <h1 class="section-heading">
                <span data-i18n="archive.title">归档</span>
                <span class="text-muted text-sm">({allPosts.length} <span data-i18n="archive.countUnit">篇</span>)</span>
            </h1>

            {years.map((year) => (
                <section class="year-section">
                    <h2 class="year-title">{year}</h2>
                    <ul class="archive-list">
                        {byYear[year].map((post) => {
                            const isZueg = post.collection === "zueg";
                            const url = isZueg ? `/posts/zueg/${post.id}` : `/posts/${post.id}`;
                            const date = post.data.pubDate;
                            const mm = String(date.getMonth() + 1).padStart(2, "0");
                            const dd = String(date.getDate()).padStart(2, "0");
                            return (
                                <li class="archive-item">
                                    <span class="archive-date">{mm}-{dd}</span>
                                    <a href={url} class="archive-title">{post.data.title}</a>
                                    {isZueg && <span class="tag" style="font-size:0.7rem" data-i18n="common.essay">随笔</span>}
                                </li>
                            );
                        })}
                    </ul>
                </section>
            ))}
        </div>
    </main>
</BaseLayout>

<style>
    .year-section {
        margin-bottom: 2rem;
    }

    .year-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 0.75rem;
        padding-bottom: 0.4rem;
        border-bottom: 1px solid var(--border);
    }

    .archive-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .archive-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.45rem 0;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
    }

    .archive-item:last-child {
        border-bottom: none;
    }

    .archive-date {
        color: var(--text-muted);
        font-size: 0.8125rem;
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .archive-title {
        color: var(--text);
        text-decoration: none;
        flex: 1;
        transition: color 150ms ease;
    }

    .archive-title:hover {
        color: var(--accent);
    }
</style>
