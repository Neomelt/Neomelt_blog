---
import { SITE_TITLE } from "../consts";
import SearchModal from "./SearchModal.astro";
---

<header id="site-header">
    <div class="header-inner">
        <!-- Site title -->
        <a href="/" class="site-title" data-i18n-aria-label="header.homeAria" aria-label="首页">
            {SITE_TITLE}
        </a>

        <!-- Desktop nav -->
        <nav class="nav-links" id="nav-links" data-i18n-aria-label="header.mainNavAria" aria-label="主导航">
            <a href="/posts" class="nav-link" data-i18n="header.posts">文章</a>
            <a href="/posts/archive" class="nav-link" data-i18n="header.archive">归档</a>
            <a href="/tags" class="nav-link" data-i18n="header.tags">标签</a>
            <a href="/friends" class="nav-link" data-i18n="header.friends">友链</a>
            <a href="/about" class="nav-link" data-i18n="header.about">关于</a>
        </nav>

        <!-- Right controls -->
        <div class="nav-controls">
            <!-- Search -->
            <button id="search-toggle" class="icon-btn" data-i18n-aria-label="header.searchAria" aria-label="搜索">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
            </button>

            <!-- Language toggle -->
            <button id="locale-toggle" class="icon-btn locale-btn" data-i18n-aria-label="header.languageAria" aria-label="切换语言">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M2 12h20" />
                    <path d="M12 2a15 15 0 0 1 0 20" />
                    <path d="M12 2a15 15 0 0 0 0 20" />
                </svg>
                <span id="locale-toggle-label" class="locale-label" data-i18n="locale.label">中文</span>
            </button>

            <!-- Theme toggle -->
            <button id="theme-toggle" class="icon-btn" data-i18n-aria-label="header.themeAria" aria-label="切换深色/浅色模式">
                <!-- Moon (shown in light mode) -->
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
                <!-- Sun (shown in dark mode) -->
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="display:none">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
            </button>

            <!-- Mobile menu toggle -->
            <button id="menu-toggle" class="icon-btn mobile-only" data-i18n-aria-label="header.menuAria" aria-label="菜单" aria-expanded="false">
                <svg id="menu-open-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
                <svg id="menu-close-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="display:none">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Mobile nav drawer -->
    <div id="mobile-nav" class="mobile-nav" aria-hidden="true">
        <a href="/posts" class="mobile-nav-link" data-i18n="header.posts">文章</a>
        <a href="/posts/archive" class="mobile-nav-link" data-i18n="header.archive">归档</a>
        <a href="/tags" class="mobile-nav-link" data-i18n="header.tags">标签</a>
        <a href="/friends" class="mobile-nav-link" data-i18n="header.friends">友链</a>
        <a href="/about" class="mobile-nav-link" data-i18n="header.about">关于</a>
    </div>
</header>

<SearchModal />

<script>
    // ---- Theme ----
    function getTheme(): "dark" | "light" {
        const saved = localStorage.getItem("theme");
        if (saved === "dark" || saved === "light") return saved;
        return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
    }

    function applyTheme(theme: "dark" | "light") {
        const moon = document.getElementById("moon-icon");
        const sun  = document.getElementById("sun-icon");
        if (theme === "dark") {
            document.documentElement.classList.add("dark");
            localStorage.setItem("theme", "dark");
            moon && (moon.style.display = "none");
            sun  && (sun.style.display  = "");
        } else {
            document.documentElement.classList.remove("dark");
            localStorage.setItem("theme", "light");
            moon && (moon.style.display = "");
            sun  && (sun.style.display  = "none");
        }
    }

    // Apply on load (also runs before DOMContentLoaded via inline script in BaseHead)
    applyTheme(getTheme());

    function initHeader() {
        applyTheme(getTheme());

        const themeToggle = document.getElementById("theme-toggle");
        if (themeToggle && !themeToggle.dataset.bound) {
            themeToggle.addEventListener("click", () => {
                const isDark = document.documentElement.classList.contains("dark");
                applyTheme(isDark ? "light" : "dark");
            });
            themeToggle.dataset.bound = "true";
        }

        // ---- Mobile menu ----
        const menuToggle   = document.getElementById("menu-toggle");
        const mobileNav    = document.getElementById("mobile-nav");
        const openIcon     = document.getElementById("menu-open-icon");
        const closeIcon    = document.getElementById("menu-close-icon");

        if (menuToggle && !menuToggle.dataset.bound) {
            menuToggle.addEventListener("click", () => {
                const isOpen = mobileNav?.classList.toggle("open");
                menuToggle.setAttribute("aria-expanded", String(isOpen));
                if (openIcon)  openIcon.style.display  = isOpen ? "none" : "";
                if (closeIcon) closeIcon.style.display = isOpen ? ""     : "none";
            });
            menuToggle.dataset.bound = "true";
        }

        // ---- Locale toggle ----
        const localeToggle = document.getElementById("locale-toggle");

        const updateLocaleLabel = () => {
            const i18n = (window as any).__siteI18n;
            const locale = i18n?.getLocale?.() === "en" ? "en" : "zh";
            const localeLabel = document.getElementById("locale-toggle-label");
            if (!localeLabel) return;
            localeLabel.textContent = i18n?.t?.("locale.label", locale === "en" ? "EN" : "中文")
                || (locale === "en" ? "EN" : "中文");
        };

        if (localeToggle && !localeToggle.dataset.bound) {
            localeToggle.addEventListener("click", () => {
                const i18n = (window as any).__siteI18n;
                i18n?.toggleLocale?.();
                updateLocaleLabel();
            });
            localeToggle.dataset.bound = "true";
        }

        const previousLocaleHandler = (window as any).__headerLocaleHandler;
        if (previousLocaleHandler) {
            document.removeEventListener("site:locale-change", previousLocaleHandler);
        }
        document.addEventListener("site:locale-change", updateLocaleLabel);
        (window as any).__headerLocaleHandler = updateLocaleLabel;
        updateLocaleLabel();

        // ---- Active nav link ----
        const path = window.location.pathname;
        document.querySelectorAll(".nav-link, .mobile-nav-link").forEach((link) => {
            link.classList.remove("active");
            const href = link.getAttribute("href") || "";
            if (href !== "/" && path.startsWith(href)) {
                link.classList.add("active");
            } else if (href === "/" && path === "/") {
                link.classList.add("active");
            }
        });
    }

    document.addEventListener("DOMContentLoaded", initHeader);
    document.addEventListener("astro:page-load", initHeader);
</script>

<style>
    #site-header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        height: var(--header-height);
    }

    .header-inner {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0 1.5rem;
        height: 100%;
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
        align-items: center;
        gap: 1rem;
    }

    .site-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text);
        text-decoration: none;
        white-space: nowrap;
        flex-shrink: 0;
        justify-self: start;
    }

    .site-title:hover {
        color: var(--accent);
    }

    .nav-links {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        justify-self: center;
        white-space: nowrap;
    }

    .nav-link {
        font-size: 1rem;
        color: var(--text-muted);
        text-decoration: none;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        transition: color 150ms ease, background 150ms ease;
    }

    .nav-link:hover,
    .nav-link.active {
        color: var(--text);
        background: var(--bg-code);
    }

    .nav-controls {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.25rem;
        justify-self: end;
    }

    .icon-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border-radius: 6px;
        color: var(--text-muted);
        background: transparent;
        border: none;
        cursor: pointer;
        transition: color 150ms ease, background 150ms ease;
    }

    .icon-btn:hover {
        color: var(--text);
        background: var(--bg-code);
    }

    .locale-btn {
        width: auto;
        padding: 0 0.55rem;
        gap: 0.35rem;
        border: 1px solid var(--border);
    }

    .locale-label {
        font-size: 0.82rem;
        font-weight: 600;
        letter-spacing: 0.01em;
    }

    /* Mobile nav drawer */
    .mobile-nav {
        display: none;
        flex-direction: column;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        padding: 0.5rem 1.25rem 1rem;
    }

    .mobile-nav.open {
        display: flex;
    }

    .mobile-nav-link {
        font-size: 0.95rem;
        color: var(--text-muted);
        text-decoration: none;
        padding: 0.6rem 0;
        border-bottom: 1px solid var(--border);
    }

    .mobile-nav-link:last-child {
        border-bottom: none;
    }

    .mobile-nav-link:hover,
    .mobile-nav-link.active {
        color: var(--accent);
    }

    /* Show mobile toggle only on small screens */
    .mobile-only {
        display: none;
    }

    @media (max-width: 640px) {
        .nav-links {
            display: none;
        }
        .mobile-only {
            display: flex;
        }
        #site-header {
            height: auto;
            min-height: var(--header-height);
        }
        .header-inner {
            height: var(--header-height);
        }
    }
</style>
