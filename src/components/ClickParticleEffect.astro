<script is:inline>
    (() => {
        const BOUND_FLAG = "__clickParticleEffectBound";
        const REDUCED_MOTION_QUERY = window.matchMedia("(prefers-reduced-motion: reduce)");
        const SMALL_SCREEN_QUERY = window.matchMedia("(max-width: 640px)");
        const SKIP_TARGET_SELECTOR = "input, textarea, select, [contenteditable='true'], .wl-editor";

        const createParticle = (x, y, angle, distance, colorIndex) => {
            const particle = document.createElement("div");
            particle.className = `click-particle color-${colorIndex}`;

            const dx = Math.cos(angle) * distance;
            const dy = Math.sin(angle) * distance;
            const size = Math.random() * 6 + 8;

            particle.style.setProperty("--dx", `${dx}px`);
            particle.style.setProperty("--dy", `${dy}px`);
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;

            document.body.appendChild(particle);
            window.setTimeout(() => particle.remove(), 1100);
        };

        let lastClickTime = 0;

        const handleParticleClick = (event) => {
            if (REDUCED_MOTION_QUERY.matches) return;
            if (event.defaultPrevented || event.button !== 0) return;

            const target = event.target;
            if (target instanceof Element && target.closest(SKIP_TARGET_SELECTOR)) return;

            const x = event.clientX;
            const y = event.clientY;
            if (!Number.isFinite(x) || !Number.isFinite(y) || (x === 0 && y === 0)) return;

            const isSmallScreen = SMALL_SCREEN_QUERY.matches;
            const debounceDelay = isSmallScreen ? 140 : 100;
            const now = Date.now();
            if (now - lastClickTime < debounceDelay) return;
            lastClickTime = now;

            const particleCount = isSmallScreen ? 8 : 10;
            const extraCount = isSmallScreen ? 2 : 4;
            const baseDistance = isSmallScreen ? 16 : 18;
            const delayStep = isSmallScreen ? 10 : 12;

            for (let i = 0; i < particleCount; i++) {
                const angle = ((Math.PI * 2) / particleCount) * i;
                const distance = baseDistance + Math.random() * 8;
                const colorIndex = (i % 10) + 1;
                window.setTimeout(() => {
                    createParticle(x, y, angle, distance, colorIndex);
                }, i * delayStep);
            }

            for (let i = 0; i < extraCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = baseDistance + Math.random() * 10;
                const colorIndex = Math.floor(Math.random() * 10) + 1;
                window.setTimeout(() => {
                    createParticle(x, y, angle, distance, colorIndex);
                }, (particleCount + i) * delayStep);
            }
        };

        const initParticleEffect = () => {
            if (window[BOUND_FLAG]) return;
            window[BOUND_FLAG] = true;
            document.addEventListener("click", handleParticleClick, { passive: true });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", initParticleEffect, { once: true });
        } else {
            initParticleEffect();
        }

        document.addEventListener("astro:page-load", initParticleEffect);
    })();
</script>

<style is:global>
    .click-particle {
        position: fixed;
        left: 0;
        top: 0;
        z-index: 9999;
        pointer-events: none;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: particle-explosion 1.1s ease-out forwards;
        box-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
    }

    .dark .click-particle {
        box-shadow: 0 0 8px rgba(255, 255, 255, 0.45);
    }

    @keyframes particle-explosion {
        0% {
            opacity: 1;
            transform: translate(-50%, -50%) scale(0.4) translate(0, 0);
        }
        15% {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.3) translate(var(--dx), var(--dy));
        }
        60% {
            opacity: 0.8;
            transform: translate(-50%, -50%) scale(1) translate(calc(var(--dx) * 2.5), calc(var(--dy) * 2.5));
        }
        100% {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.3) translate(calc(var(--dx) * 3.5), calc(var(--dy) * 3.5));
        }
    }

    .click-particle.color-1 { background: radial-gradient(circle, #ffb3ba, #ffc1cc); }
    .click-particle.color-2 { background: radial-gradient(circle, #a8d8ff, #bde4ff); }
    .click-particle.color-3 { background: radial-gradient(circle, #ffe66d, #fff2a8); }
    .click-particle.color-4 { background: radial-gradient(circle, #d4a5ff, #e6ccff); }
    .click-particle.color-5 { background: radial-gradient(circle, #a8e6a8, #c1ffc1); }
    .click-particle.color-6 { background: radial-gradient(circle, #ffcc99, #ffd4a3); }
    .click-particle.color-7 { background: radial-gradient(circle, #b3deff, #c4e8ff); }
    .click-particle.color-8 { background: radial-gradient(circle, #f5c2c7, #f8d7da); }
    .click-particle.color-9 { background: radial-gradient(circle, #c3e6c3, #d1f2d1); }
    .click-particle.color-10 { background: radial-gradient(circle, #ffe8b3, #fff0d4); }

    .dark .click-particle.color-1 { background: radial-gradient(circle, #ff4757, #ff6b8a); }
    .dark .click-particle.color-2 { background: radial-gradient(circle, #29b6f6, #4fc3f7); }
    .dark .click-particle.color-3 { background: radial-gradient(circle, #ffca28, #ffd54f); }
    .dark .click-particle.color-4 { background: radial-gradient(circle, #ab47bc, #ba68c8); }
    .dark .click-particle.color-5 { background: radial-gradient(circle, #66bb6a, #81c784); }
    .dark .click-particle.color-6 { background: radial-gradient(circle, #ffa726, #ffb74d); }
    .dark .click-particle.color-7 { background: radial-gradient(circle, #42a5f5, #64b5f6); }
    .dark .click-particle.color-8 { background: radial-gradient(circle, #f06292, #f48fb1); }
    .dark .click-particle.color-9 { background: radial-gradient(circle, #81c784, #a5d6a7); }
    .dark .click-particle.color-10 { background: radial-gradient(circle, #ffd54f, #ffe082); }
</style>
