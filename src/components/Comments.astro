---
import { normalizeWalinePath } from "../utils/waline";

interface Props {
	path?: string;
}

const { path = Astro.url.pathname } = Astro.props;
const walinePath = normalizeWalinePath(path);
const serverURL = (import.meta.env.PUBLIC_WALINE_SERVER_URL ?? "").trim();
const walineScriptUrls = [
	"https://unpkg.com/@waline/client@3.12.2/dist/waline.umd.js",
	"https://cdn.jsdelivr.net/npm/@waline/client@3.12.2/dist/waline.umd.js",
];
const walineEmojiUrls = [
	"https://cdn.jsdelivr.net/npm/@waline/emojis@1.4.0/bmoji",
	"https://cdn.jsdelivr.net/npm/@waline/emojis@1.4.0/bilibili",
];
---

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@waline/client@3.12.2/dist/waline.css" />

<div class="comments-wrapper">
	{serverURL ? (
		<div id="waline"></div>
	) : (
		<div class="comments-config-tip">
			未配置 Waline 服务地址。请在环境变量中设置 <code>PUBLIC_WALINE_SERVER_URL</code>。
		</div>
	)}
</div>

{
	serverURL && (
		<script define:vars={{ serverURL, walinePath, walineScriptUrls, walineEmojiUrls }}>
			(() => {
				const loadWalineClient = () => {
					if (window.Waline?.init) return Promise.resolve(window.Waline);
					if (window.__walineClientPromise) return window.__walineClientPromise;

					const sources = Array.isArray(walineScriptUrls) ? walineScriptUrls : [];
					const tryLoad = (index) =>
						new Promise((resolve, reject) => {
							const src = sources[index];
							if (!src) {
								reject(new Error("No Waline client CDN source available"));
								return;
							}

							const existing = document.querySelector(
								`script[data-waline-client-src="${src}"]`,
							);
							if (existing) {
								if (window.Waline?.init) {
									resolve(window.Waline);
									return;
								}
								existing.addEventListener("load", () => resolve(window.Waline), {
									once: true,
								});
								existing.addEventListener(
									"error",
									() => reject(new Error(`Failed loading ${src}`)),
									{ once: true },
								);
								return;
							}

							const script = document.createElement("script");
							script.src = src;
							script.async = true;
							script.dataset.walineClientSrc = src;
							script.onload = () => {
								if (window.Waline?.init) resolve(window.Waline);
								else reject(new Error(`Waline global not found after loading ${src}`));
							};
							script.onerror = () => reject(new Error(`Failed loading ${src}`));
							document.head.appendChild(script);
						}).catch((error) => {
							if (index >= sources.length - 1) throw error;
							return tryLoad(index + 1);
						});

					window.__walineClientPromise = tryLoad(0);
					return window.__walineClientPromise;
				};

				loadWalineClient()
					.then((waline) => {
						if (!document.querySelector("#waline")) return;

						waline.init({
							el: "#waline",
							serverURL,
							path: walinePath,
							lang: "zh-CN",
							dark: "html.dark",
							emoji: walineEmojiUrls,
							pageview: true,
							comment: true,
							meta: ["nick", "mail", "link"],
							requiredMeta: ["nick", "mail"],
						});
					})
					.catch((error) => {
						console.error("[Waline] Failed to initialize comment widget:", error);
					});
			})();
		</script>
	)
}

<style>
	.comments-wrapper {
		width: min(120vw, 1000px);
		max-width: calc(100% - 2em);
		margin: 4rem auto 0;
		padding: 2rem clamp(1em, 3vw, 2em) 0;
		border-top: 1px solid var(--border);
	}

	.comments-config-tip {
		padding: 0.9rem 1rem;
		border: 1px dashed var(--border);
		border-radius: 8px;
		background: var(--bg-code);
		color: var(--text-muted);
		font-size: 0.9rem;
	}

	.comments-config-tip code {
		color: var(--text);
		font-family: var(--font-mono);
	}

	:global(.wl-editor),
	:global(.wl-panel),
	:global(.wl-card),
	:global(.wl-empty) {
		background: var(--bg-card);
		border-color: var(--border);
	}

	:global(.wl-textarea),
	:global(.wl-input),
	:global(.wl-count) {
		color: var(--text);
	}
</style>
