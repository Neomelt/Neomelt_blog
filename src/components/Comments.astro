---
import { normalizeWalinePath } from "../utils/waline";

interface Props {
	path?: string;
}

const { path = Astro.url.pathname } = Astro.props;
const walinePath = normalizeWalinePath(path);
const serverURL = (import.meta.env.PUBLIC_WALINE_SERVER_URL ?? "").trim();
---

<link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />

<div class="comments-wrapper">
	{serverURL ? (
		<div id="waline"></div>
	) : (
		<div class="comments-config-tip">
			未配置 Waline 服务地址。请在环境变量中设置 <code>PUBLIC_WALINE_SERVER_URL</code>。
		</div>
	)}
</div>

{
	serverURL && (
		<script type="module" define:vars={{ serverURL, walinePath }}>
			import { init } from "https://unpkg.com/@waline/client@v3/dist/waline.js";

			init({
				el: "#waline",
				serverURL,
				path: walinePath,
				lang: "zh-CN",
				dark: "html.dark",
				emoji: [
					"https://unpkg.com/@waline/emojis@1.4.0/bmoji",
					"https://unpkg.com/@waline/emojis@1.4.0/bilibili",
				],
				pageview: true,
				comment: true,
				meta: ["nick", "mail", "link"],
				requiredMeta: ["nick", "mail"],
			});
		</script>
	)
}

<style>
	.comments-wrapper {
		width: min(120vw, 1000px);
		max-width: calc(100% - 2em);
		margin: 4rem auto 0;
		padding: 2rem clamp(1em, 3vw, 2em) 0;
		border-top: 1px solid var(--border);
	}

	.comments-config-tip {
		padding: 0.9rem 1rem;
		border: 1px dashed var(--border);
		border-radius: 8px;
		background: var(--bg-code);
		color: var(--text-muted);
		font-size: 0.9rem;
	}

	.comments-config-tip code {
		color: var(--text);
		font-family: var(--font-mono);
	}

	:global(.wl-editor),
	:global(.wl-panel),
	:global(.wl-card),
	:global(.wl-empty) {
		background: var(--bg-card);
		border-color: var(--border);
	}

	:global(.wl-textarea),
	:global(.wl-input),
	:global(.wl-count) {
		color: var(--text);
	}
</style>
