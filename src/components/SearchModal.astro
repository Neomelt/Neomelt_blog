---
import { getDefaultUiText } from "../i18n/ui";

const searchFallbacks = {
    "search.dialogAria": getDefaultUiText("search.dialogAria"),
    "search.title": getDefaultUiText("search.title"),
    "search.closeAria": getDefaultUiText("search.closeAria"),
    "search.placeholder": getDefaultUiText("search.placeholder"),
    "search.emptyStart": getDefaultUiText("search.emptyStart"),
    "search.emptyNotFound": getDefaultUiText("search.emptyNotFound"),
    "search.emptyMinChars": getDefaultUiText("search.emptyMinChars"),
    "search.emptyLoading": getDefaultUiText("search.emptyLoading"),
} as const;
---

<div id="search-modal" class="search-overlay" aria-hidden="true">
    <div class="search-box" role="dialog" aria-modal="true" data-i18n-aria-label="search.dialogAria" aria-label={searchFallbacks["search.dialogAria"]}>
        <div class="search-header">
            <h3 class="search-title" data-i18n="search.title">{searchFallbacks["search.title"]}</h3>
            <button id="close-search" class="search-close" data-i18n-aria-label="search.closeAria" aria-label={searchFallbacks["search.closeAria"]}>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="search-body">
            <div class="search-input-wrap">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
                <input
                    type="text"
                    id="search-input"
                    class="search-input"
                    data-i18n-placeholder="search.placeholder"
                    placeholder={searchFallbacks["search.placeholder"]}
                    autocomplete="off"
                />
            </div>
            <div id="search-results" class="search-results">
                <div class="search-empty" data-i18n="search.emptyStart">{searchFallbacks["search.emptyStart"]}</div>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ searchFallbacks }}>
    function initSearch() {
        let searchIndex = [];
        let isLoading = false;
        const i18n = window.__siteI18n;
        const getFallback = (key, fallback = "") => {
            const fromDict = searchFallbacks[key];
            return fromDict || fallback || key;
        };
        const t = (key, fallback = "") => i18n?.t?.(key, getFallback(key, fallback)) || getFallback(key, fallback);

        const searchToggle = document.getElementById("search-toggle");
        const searchModal = document.getElementById("search-modal");
        const closeSearch = document.getElementById("close-search");
        const searchInput = document.getElementById("search-input");
        const searchResults = document.getElementById("search-results");

        if (!searchModal || !closeSearch || !searchInput || !searchResults) return;

        function renderEmpty(key, fallback = "") {
            searchResults.innerHTML = `<div class="search-empty">${t(key, fallback)}</div>`;
        }

        function openModal() {
            searchModal.classList.add("open");
            searchModal.setAttribute("aria-hidden", "false");
            searchInput.focus();
            document.body.style.overflow = "hidden";
            if (!searchInput.value.trim()) {
                renderEmpty("search.emptyStart");
            }
            loadSearchIndex();
        }

        function closeModal() {
            searchModal.classList.remove("open");
            searchModal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        }

        // 加载搜索索引
        async function loadSearchIndex() {
            if (searchIndex.length > 0 || isLoading) return;
            isLoading = true;
            try {
                const response = await fetch("/api/search.json");
                if (response.ok) {
                    searchIndex = await response.json();
                }
            } catch (e) {
                console.error("[Search] Failed to load search index:", e);
            } finally {
                isLoading = false;
            }
        }

        // 执行搜索
        function performSearch(query) {
            if (!query.trim()) return [];
            const term = query.toLowerCase();
            return searchIndex
                .filter((item) => {
                    return (
                        item.title.toLowerCase().includes(term) ||
                        item.description?.toLowerCase().includes(term) ||
                        item.content?.toLowerCase().includes(term) ||
                        item.tags?.some((t) => t.toLowerCase().includes(term))
                    );
                })
                .slice(0, 10);
        }

        // 高亮关键词
        function highlight(text, query) {
            if (!query.trim() || !text) return text || "";
            const regex = new RegExp(
                `(${query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
                "gi"
            );
            return text.replace(regex, '<mark>$1</mark>');
        }

        // 渲染搜索结果
        function renderResults(results, query) {
            if (!searchResults) return;
            if (results.length === 0) {
                renderEmpty("search.emptyNotFound");
                return;
            }
            searchResults.innerHTML = results
                .map((item) => {
                    const desc = item.description
                        ? `<div class="result-desc">${highlight(item.description, query)}</div>`
                        : "";
                    const tags = item.tags?.length
                        ? `<div class="result-tags">${item.tags.map((t) => `<span class="result-tag">#${t}</span>`).join("")}</div>`
                        : "";
                    return `
                        <a href="${item.url}" class="result-item" onclick="document.getElementById('search-modal')?.classList.remove('open');document.body.style.overflow=''">
                            <div class="result-title">${highlight(item.title, query)}</div>
                            ${desc}
                            ${tags}
                        </a>
                    `;
                })
                .join("");
        }

        // 防抖
        function debounce(fn, wait) {
            let timer = null;
            return (...args) => {
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => fn(...args), wait);
            };
        }

        // 事件绑定
        if (searchToggle && !searchToggle.dataset.searchBound) {
            searchToggle.addEventListener("click", openModal);
            searchToggle.dataset.searchBound = "true";
        }
        if (!closeSearch.dataset.searchBound) {
            closeSearch.addEventListener("click", closeModal);
            closeSearch.dataset.searchBound = "true";
        }
        if (!searchModal.dataset.searchBound) {
            searchModal.addEventListener("click", (e) => {
                if (e.target === searchModal) closeModal();
            });
            searchModal.dataset.searchBound = "true";
        }
        const previousKeydownHandler = window.__searchKeydownHandler;
        if (previousKeydownHandler) {
            document.removeEventListener("keydown", previousKeydownHandler);
        }
        const keydownHandler = (e) => {
            if (e.key === "Escape" && searchModal.classList.contains("open")) {
                closeModal();
            }
            // Ctrl+K / Cmd+K 打开搜索
            if ((e.ctrlKey || e.metaKey) && e.key === "k") {
                e.preventDefault();
                searchModal.classList.contains("open") ? closeModal() : openModal();
            }
        };
        document.addEventListener("keydown", keydownHandler);
        window.__searchKeydownHandler = keydownHandler;

        if (!searchInput.dataset.searchBound) {
            searchInput.addEventListener(
                "input",
                debounce(async () => {
                    const query = searchInput.value.trim();
                    if (query.length < 2) {
                        renderEmpty("search.emptyMinChars");
                        return;
                    }
                    if (searchIndex.length === 0 && !isLoading) {
                        renderEmpty("search.emptyLoading");
                        await loadSearchIndex();
                    }
                    renderResults(performSearch(query), query);
                }, 250)
            );
            searchInput.dataset.searchBound = "true";
        }

        const previousLocaleHandler = window.__searchLocaleHandler;
        if (previousLocaleHandler) {
            document.removeEventListener("site:locale-change", previousLocaleHandler);
        }
        const localeHandler = () => {
            const query = searchInput.value.trim();
            if (!searchModal.classList.contains("open")) return;
            if (!query) {
                renderEmpty("search.emptyStart");
            } else if (query.length < 2) {
                renderEmpty("search.emptyMinChars");
            }
        };
        document.addEventListener("site:locale-change", localeHandler);
        window.__searchLocaleHandler = localeHandler;
    }

    // 初始化（兼容普通加载和 Astro view transitions）
    document.addEventListener("DOMContentLoaded", initSearch);
    document.addEventListener("astro:page-load", initSearch);
</script>

<style>
    /* 遮罩层 — 默认隐藏 */
    .search-overlay {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 200;
        background: rgba(0, 0, 0, 0.5);
        align-items: flex-start;
        justify-content: center;
        padding-top: 10vh;
    }

    .search-overlay.open {
        display: flex;
    }

    /* 搜索框容器 */
    .search-box {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        width: 100%;
        max-width: 600px;
        margin: 0 1rem;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    /* 头部 */
    .search-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
    }

    .search-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text);
        margin: 0;
    }

    .search-close {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        transition: color var(--transition), background var(--transition);
    }

    .search-close:hover {
        color: var(--text);
        background: var(--bg-code);
    }

    /* 搜索体 */
    .search-body {
        padding: 1rem 1.25rem 1.25rem;
    }

    /* 输入框 */
    .search-input-wrap {
        position: relative;
        margin-bottom: 1rem;
    }

    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
    }

    .search-input {
        width: 100%;
        padding: 0.6rem 0.75rem 0.6rem 2.25rem;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg);
        color: var(--text);
        font-size: 0.95rem;
        font-family: var(--font-sans);
        outline: none;
        transition: border-color var(--transition);
    }

    .search-input:focus {
        border-color: var(--accent);
    }

    /* 结果区域 */
    .search-results {
        max-height: 400px;
        overflow-y: auto;
    }

    .search-empty {
        padding: 1.5rem;
        text-align: center;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    /* 单条结果 */
    .result-item {
        display: block;
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid var(--border);
        text-decoration: none;
        color: var(--text);
        transition: background var(--transition);
        border-radius: 6px;
    }

    .result-item:last-child {
        border-bottom: none;
    }

    .result-item:hover {
        background: var(--bg-code);
    }

    .result-title {
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--text);
        margin-bottom: 0.25rem;
    }

    .result-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .result-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-top: 0.25rem;
    }

    .result-tag {
        font-size: 0.75rem;
        color: var(--tag-text);
        background: var(--tag-bg);
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
    }

    mark {
        background: rgba(250, 204, 21, 0.3);
        color: inherit;
        border-radius: 2px;
    }
</style>
