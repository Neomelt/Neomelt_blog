---
// TableOfContents.astro — minimalist sticky TOC
export interface Props {
    headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;
const tocHeadings = headings.filter(h => h.depth <= 3);
---

{tocHeadings.length > 0 && (
    <nav class="toc" data-i18n-aria-label="toc.aria" aria-label="目录">
        <p class="toc-label" data-i18n="toc.label">目录</p>
        <ul class="toc-list">
            {tocHeadings.map((h) => (
                <li class={`toc-item toc-h${h.depth}`}>
                    <a href={`#${h.slug}`} class="toc-link">{h.text}</a>
                </li>
            ))}
        </ul>
    </nav>
)}

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const links = document.querySelectorAll(".toc-link");
        if (!links.length) return;

        const observer = new IntersectionObserver(
            (entries) => {
                for (const entry of entries) {
                    if (entry.isIntersecting) {
                        links.forEach(l => l.classList.remove("active"));
                        const id = entry.target.getAttribute("id");
                        document.querySelector(`.toc-link[href="#${id}"]`)?.classList.add("active");
                    }
                }
            },
            { rootMargin: "-80px 0px -60% 0px", threshold: 1.0 }
        );

        document.querySelectorAll("article h2, article h3").forEach(h => observer.observe(h));

        links.forEach(link => {
            link.addEventListener("click", (e) => {
                e.preventDefault();
                const id = link.getAttribute("href")?.slice(1);
                const el = id ? document.getElementById(id) : null;
                if (el) {
                    const top = el.getBoundingClientRect().top + window.scrollY - 80;
                    window.scrollTo({ top, behavior: "smooth" });
                }
            });
        });
    });
</script>

<style>
    .toc {
        font-size: 0.8125rem;
    }

    .toc-label {
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.6rem;
    }

    .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .toc-item {
        margin: 0;
    }

    .toc-link {
        display: block;
        padding: 0.25rem 0;
        color: var(--text-muted);
        text-decoration: none;
        border-left: 2px solid transparent;
        padding-left: 0.6rem;
        line-height: 1.4;
        transition: color 150ms ease, border-color 150ms ease;
    }

    .toc-link:hover,
    .toc-link.active {
        color: var(--accent);
        border-left-color: var(--accent);
    }

    .toc-h3 .toc-link {
        padding-left: 1.2rem;
        font-size: 0.8rem;
    }
</style>
